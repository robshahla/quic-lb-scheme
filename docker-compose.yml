version: "3.5"
networks:
  scheme-network:
    name: scheme-network
    driver: bridge
    driver_opts:
      com.docker.network.enable_ipv6: "true"
    ipam:
      config:
        - subnet: 172.18.0.0/16

services:
  my-running-load-balancer:
    hostname: my-running-load-balancer
    container_name: my-running-load-balancer
    image: my-load-balancer-new
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - sys_ptrace
    ports:
      - "2222:22"
    networks:
      scheme-network:
        ipv4_address: 172.18.1.2
    mac_address: 02:42:ac:12:01:02

  my-running-nat:
    hostname: my-running-nat
    container_name: my-running-nat
    image: my-load-balancer
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - sys_ptrace
    ports:
      - "2223:22"
    networks:
      scheme-network:
        ipv4_address: 172.18.1.3
    command: >-
      sh -c "apt-get install -y conntrack &&
      tail -f /dev/null"

  my-running-client:
    hostname: my-running-client
    container_name: my-running-client
    image: my-proxygen
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - sys_ptrace
    networks:
      scheme-network:
        ipv4_address: 172.18.0.2
    command: >-
      sh -c "apt-get install -y iproute2 iptables conntrack tcpdump &&
      tail -f /dev/null"

  my-proxygen-server-0:
    hostname: my-proxygen-server
    container_name: my-proxygen-server-0
    image: my-proxygen
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - sys_ptrace
    networks:
      scheme-network:
        ipv4_address: 172.18.2.2
    mac_address: 02:42:ac:12:02:02
    volumes:
      - ./quic-lb-proxygen:/usr/src/proxygen
    links:
      - my-running-nat
    command: >-
      sh -c "apt-get install -y iproute2 iptables tcpdump conntrack &&
      ip route del 172.18.0.0/16 &&
      ip r a 172.18.0.0/16 via 172.18.1.3 dev eth0 onlink &&
      ip route del default &&
      ip r a default via 172.18.1.3 dev eth0 onlink &&
      touch psk.txt &&
      cp ./proxygen/server.crt /etc/ssl/certs &&
      cp ./proxygen/server.key /etc/ssl/private &&
      ./proxygen/proxygen/_build/proxygen/httpserver/hq --mode=server --host=172.18.2.2 --port=6666 --early_data=true --psk_file=./psk.txt --protocol=h3 --cert=/etc/ssl/certs/server.crt --key=/etc/ssl/private/server.key"

  my-proxygen-server-1:
    hostname: my-proxygen-server
    container_name: my-proxygen-server-1
    image: my-proxygen
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - sys_ptrace
    networks:
      scheme-network:
        ipv4_address: 172.18.2.3
    mac_address: 02:42:ac:12:02:03
    volumes:
      - ./quic-lb-proxygen:/usr/src/proxygen
    links:
      - my-running-nat
    command: >-
      sh -c "apt-get install -y iproute2 iptables tcpdump conntrack &&
      ip route del 172.18.0.0/16 &&
      ip r a 172.18.0.0/16 via 172.18.1.3 dev eth0 onlink &&
      ip route del default &&
      ip r a default via 172.18.1.3 dev eth0 onlink &&
      ./proxygen/proxygen/_build/proxygen/httpserver/hq --mode=server --host=172.18.2.3 --port=6666 --early_data=true"

  my-proxygen-server-2:
    hostname: my-proxygen-server
    container_name: my-proxygen-server-2
    image: my-proxygen
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - sys_ptrace
    networks:
      scheme-network:
        ipv4_address: 172.18.2.4
    mac_address: 02:42:ac:12:02:04
    volumes:
      - ./quic-lb-proxygen:/usr/src/proxygen
    links:
      - my-running-nat
    command: >-
      sh -c "apt-get install -y iproute2 iptables tcpdump conntrack &&
      ip route del 172.18.0.0/16 &&
      ip r a 172.18.0.0/16 via 172.18.1.3 dev eth0 onlink &&
      ip route del default &&
      ip r a default via 172.18.1.3 dev eth0 onlink &&
      ./proxygen/proxygen/_build/proxygen/httpserver/hq --mode=server --host=172.18.2.4 --port=6666 --early_data=true"

  my-proxygen-server-3:
    hostname: my-proxygen-server
    container_name: my-proxygen-server-3
    image: my-proxygen
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - sys_ptrace
    networks:
      scheme-network:
        ipv4_address: 172.18.2.5
    mac_address: 02:42:ac:12:02:05
    volumes:
      - ./quic-lb-proxygen:/usr/src/proxygen
    links:
      - my-running-nat
    command: >-
      sh -c "apt-get install -y iproute2 iptables tcpdump conntrack &&
      ip route del 172.18.0.0/16 &&
      ip r a 172.18.0.0/16 via 172.18.1.3 dev eth0 onlink &&
      ip route del default &&
      ip r a default via 172.18.1.3 dev eth0 onlink &&
      ./proxygen/proxygen/_build/proxygen/httpserver/hq --mode=server --host=172.18.2.5 --port=6666 --early_data=true"

#/proxygen/proxygen/_build/proxygen/httpserver/hq --mode=client --host=172.18.1.2 --port=8888 --path="/10" --sequential=true --early_data=true --qlogger_path=. --psk_file=./psk